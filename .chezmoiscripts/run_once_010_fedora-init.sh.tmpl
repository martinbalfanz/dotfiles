#!/usr/bin/env bash
#
# Fedora post-install setup. Runs once per machine.
# Only executes on the fedora profile

{{ if .isFedora -}}

set -euo pipefail

log()  { echo -e "\n\033[1;34m==>\033[0m $*"; }
ok()   { echo -e "\033[1;32m  ✔\033[0m $*"; }
warn() { echo -e "\033[1;33m  !\033[0m $*"; }
warn_pause() {
    echo -e "\033[1;33m  !\033[0m $*"
    read -rp $'\033[1;33m    Press Enter to continue...\033[0m' _
}
die()  { echo -e "\033[1;31m  ✘\033[0m $*" >&2; exit 1; }

set_config_value() {
    # TODO: consider `crudini` for ini files, but this is good enough for now and doesn't require an extra dependency
    local file="$1"
    local key="$2"
    local value="$3"
    local separator="${4:-=}"

    if grep -qE "^\s*${key}\s*${separator}" "$file"; then
        # Key exists -- update it
        sudo sed -i.bak -E "s|^\s*${key}\s*${separator}.*|${key}${separator}${value}|" "$file"
        echo "Updated: ${key}${separator}${value} in ${file}"
    else
        # Key missing -- append it
        sudo sh -c "echo '${key}${separator}${value}' >> $file"
        echo "Added: ${key}${separator}${value} to ${file}"
    fi
}

# =============================================================================
# TUNE DNF
# =============================================================================

log "Tuning DNF"

DNF_CONF="/etc/dnf/dnf.conf"

set_config_value "$DNF_CONF" "max_parallel_downloads" "10"
set_config_value "$DNF_CONF" "fastestmirror" "True"
set_config_value "$DNF_CONF" "defaultyes" "True"
set_config_value "$DNF_CONF" "keepcache" "True"

ok "DNF tuned"

# =============================================================================
# SYSTEM UPDATE
# =============================================================================

log "Updating system"
sudo dnf upgrade -y
ok "System up to date"

# =============================================================================
# FIRMWARE UPDATES
# =============================================================================

log "Checking firmware updates"
sudo fwupdmgr refresh --force || warn "fwupd refresh failed -- skipping"
sudo fwupdmgr update -y --no-reboot-check || warn "No firmware updates available or update failed"
ok "Firmware checked"

# =============================================================================
# RPM FUSION
# =============================================================================

log "Adding RPM Fusion repositories"

FEDORA_VER=$(rpm -E %fedora)
RPM_FREE="https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-${FEDORA_VER}.noarch.rpm"
RPM_NONFREE="https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-${FEDORA_VER}.noarch.rpm"

sudo dnf install -y "$RPM_FREE" "$RPM_NONFREE"

# Pulls AppStream metadata so GNOME Software / KDE Discover can see RPM Fusion apps
sudo dnf group install core

ok "RPM Fusion (free + nonfree) added"

# =============================================================================
# MULTIMEDIA CODECS
# =============================================================================

log "Installing multimedia codecs"

# Replace the stub ffmpeg with the full RPM Fusion build
sudo dnf swap -y ffmpeg-free ffmpeg --allowerasing

# Full GStreamer plugin set (--exclude avoids a conflict with PackageKit)
sudo dnf group install multimedia \
    --setopt="install_weak_deps=False" \
    --exclude=PackageKit-gstreamer-plugin

# Additional sound and video support
sudo dnf group install sound-and-video

ok "Codecs installed"

# =============================================================================
# HARDWARE VIDEO ACCELERATION (VA-API)
# =============================================================================

log "Installing hardware video acceleration"

if lspci | grep -qi "intel.*graphics"; then
    sudo dnf install -y intel-media-driver libva-intel-driver
    ok "Intel VA-API drivers installed"
fi

if lspci | grep -qi "amd.*radeon\|advanced micro devices.*display"; then
    sudo dnf install -y mesa-va-drivers mesa-vdpau-drivers
    ok "AMD VA-API drivers installed"
fi

if lspci | grep -qi "nvidia"; then
    # nvidia-vaapi-driver requires the NVIDIA proprietary driver to be installed.
    # If you haven't installed the NVIDIA driver yet, do that first via:
    #   sudo dnf install akmod-nvidia
    # Then reboot and re-run this script, or install nvidia-vaapi-driver manually.
    sudo dnf install -y nvidia-vaapi-driver libva-utils || \
        warn_pause "NVIDIA VA-API install failed — install akmod-nvidia first, then reboot and retry"
fi

ok "VA-API step complete"

# =============================================================================
# FULL FLATHUB
# =============================================================================

log "Enabling full Flathub"

flatpak remote-add --user --if-not-exists flathub \
    https://dl.flathub.org/repo/flathub.flatpakrepo

# Disable the filtered Fedora remote to avoid duplicate search results
flatpak remote-modify --user fedora --disable 2>/dev/null || true

ok "Flathub enabled"

# =============================================================================
# GNOME TOOLS
# =============================================================================

log "Installing GNOME tools"

sudo dnf install -y \
    gnome-tweaks \
    dconf-editor

flatpak install -y -u flathub com.mattjakeman.ExtensionManager

ok "GNOME tools installed"

# =============================================================================
# AUTOMATIC SECURITY UPDATES
# =============================================================================

log "Configuring automatic updates"

sudo dnf install -y dnf-automatic

set_config_value /etc/dnf/automatic.conf "apply_updates" "True"

sudo systemctl enable --now dnf-automatic.timer

ok "Automatic updates enabled"

# =============================================================================
# DONE
# =============================================================================

echo ""
ok "Fedora post-install setup complete!"
warn "A reboot is recommended to activate the updated kernel and any firmware changes."
echo ""

{{- else }}

exit 0

{{- end }}